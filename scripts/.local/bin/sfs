#!/bin/bash
# sfs - Simple SSHFS mount manager (relies on ~/.ssh/config for ControlMaster)

set -euo pipefail

readonly MOUNT_DIR="${HOME}/.local/mnt/sfs"
readonly RED='\033[0;31m' GREEN='\033[0;32m' NC='\033[0m'

error() { echo -e "[${RED}error${NC}]: $1" >&2; exit 1; }
info() { echo -e "[${GREEN}info${NC}]: $1" >&2; }

is_mounted() { findmnt -t fuse.sshfs -n "$1" &>/dev/null; }

do_mount() {
    local host="$1" remote_path="$2" mount_point="$3"
    local opts="reconnect,ServerAliveInterval=15,ServerAliveCountMax=3,uid=$(id -u),gid=$(id -g),auto_cache"

    mkdir -p "$mount_point"
    sshfs "${host}:${remote_path}" "$mount_point" -o "$opts" && info "Mounted at $mount_point"
}

do_unmount() {
    local mp="$1"
    fusermount -u "$mp" 2>/dev/null || fusermount3 -u "$mp" 2>/dev/null || umount -l "$mp"
    rmdir "$mp" 2>/dev/null || true
}

cmd_connect() {
    local host="$1" remote_path="${2:-}"
    local mount_point="${MOUNT_DIR}/${host}"

    is_mounted "$mount_point" && error "Already mounted: $mount_point"

    [[ -z "$remote_path" ]] && remote_path=$(ssh "$host" 'echo $HOME')
    do_mount "$host" "$remote_path" "$mount_point"
}

cmd_disconnect() {
    local host="$1"
    local mount_point="${MOUNT_DIR}/${host}"
    is_mounted "$mount_point" || error "Not mounted: $mount_point"
    do_unmount "$mount_point" && info "Disconnected from $host"
}

cmd_ssh() {
    local host="$1" remote_path="${2:-}"
    if [[ -n "$remote_path" ]]; then
        exec ssh -t "$host" "cd $(printf '%q' "$remote_path") && exec \$SHELL -l"
    else
        exec ssh "$host"
    fi
}

cmd_home() {
    ssh "$1" 'echo $HOME'
}

case "${1:-}" in
    connect)    [[ $# -ge 2 ]] || error "Usage: sfs connect <host> [path]"; cmd_connect "$2" "${3:-}" ;;
    disconnect) [[ $# -ge 2 ]] || error "Usage: sfs disconnect <host>"; cmd_disconnect "$2" ;;
    ssh)        [[ $# -ge 2 ]] || error "Usage: sfs ssh <host> [path]"; cmd_ssh "$2" "${3:-}" ;;
    list)       findmnt -t fuse.sshfs -o SOURCE,TARGET 2>/dev/null || info "No mounts" ;;
    home)       [[ $# -ge 2 ]] || error "Usage: sfs home <host>"; cmd_home "$2" ;;
    *)          echo "Usage: sfs {connect|disconnect|ssh|list|home} [args]" ;;
esac
